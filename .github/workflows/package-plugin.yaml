name: Package IDA Plugin ðŸ“¦

on:
  push:
  workflow_dispatch:

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Download workflow artifact
      uses: dawidd6/action-download-artifact@v16
      with:

        # the target repo for external artifacts (built libs)
        repo: starsunyzl/keystone
        branch: master

        # token to fetch artifacts from the repo
        github_token: ${{secrets.GITHUB_TOKEN}}

        # which workflow to search for artifacts
        workflow: python-publish.yml
        workflow_conclusion: success

    - name: Package distributions
      shell: bash
      run: |
        mkdir dist && cd dist
        mkdir -p win32/Patching && cp -r ../plugins/* ./win32/Patching/ && cp -r ../artifact_windows-latest/keystone_win32/* ./win32/Patching/patching/keystone && cd ./win32 && zip -r ../patching-windows-x64.zip ./* && cd ..
        mkdir -p linux/Patching && cp -r ../plugins/* ./linux/Patching/ && cp -r ../artifact_ubuntu-latest/keystone_linux/* ./linux/Patching/patching/keystone && cd ./linux && zip -r ../patching-linux-x64.zip ./* && cd ..
        mkdir -p darwin/Patching && cp -r ../plugins/* ./darwin/Patching/ && cp -r ../artifact_macos-latest/keystone_darwin/* ./darwin/Patching/patching/keystone && cd ./darwin && zip -r ../patching-macos-universal.zip ./* && cd ..

    - uses: actions/upload-artifact@v7
      with:
         path: ${{ github.workspace }}/dist/*.zip
